<!DOCTYPE html>
<html lang="zh-SG">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P5 ä½œæ–‡å¤§çº²è§„åˆ’å™¨ (Teacher Edition)</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Import Map: è¿™é‡Œå®šä¹‰äº† React å’Œ Firebase çš„ç½‘ç»œåœ°å€ -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Map, Flag, Mountain, Footprints, Sun, Clock, User, Home, 
            AlertCircle, Smile, Frown, Lightbulb, CheckCircle, ArrowRight, 
            ArrowLeft, Save, Edit3, BookOpen, Star, Sparkles, Wand2, 
            Loader2, MessageSquare, Users, Eye, LogIn
        } from 'lucide-react';

        // --- FIREBASE é…ç½®åŒº (è¯·åœ¨è¿™é‡Œå¡«å…¥æ‚¨çš„é…ç½®ï¼Œå¦åˆ™äº‘ç«¯åŠŸèƒ½æ— æ³•ä½¿ç”¨) ---
        // å¦‚æœæ²¡æœ‰é…ç½®ï¼ŒUI ä¾ç„¶å¯ä»¥è¿è¡Œï¼Œä½†æ— æ³•ä¿å­˜ã€‚
        const FIREBASE_CONFIG = {
            // apiKey: "YOUR_API_KEY",
            // authDomain: "YOUR_PROJECT.firebaseapp.com",
            // projectId: "YOUR_PROJECT_ID",
            // storageBucket: "YOUR_PROJECT.appspot.com",
            // messagingSenderId: "...",
            // appId: "..."
        };

        const GEMINI_API_KEY = ""; // å¡«å…¥æ‚¨çš„ Gemini API Key ä»¥å¯ç”¨ AI åŠŸèƒ½

        // --- FIREBASE åˆå§‹åŒ– (å¸¦å®¹é”™å¤„ç†) ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp } from 'firebase/firestore';

        let app, auth, db;
        let isFirebaseAvailable = false;

        try {
            if (FIREBASE_CONFIG.apiKey) {
                app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseAvailable = true;
            } else {
                console.warn("æœªæ£€æµ‹åˆ° Firebase é…ç½®ï¼Œè¿è¡Œåœ¨ç¦»çº¿æ¼”ç¤ºæ¨¡å¼ã€‚");
            }
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±è´¥:", e);
        }

        const appId = 'p5-planner-app';

        // --- MAIN APP COMPONENT ---
        const App = () => {
          const [user, setUser] = useState(null);
          const [view, setView] = useState('login'); 
          const [studentName, setStudentName] = useState('');
          
          useEffect(() => {
            if (isFirebaseAvailable) {
                signInAnonymously(auth).catch(console.error);
                const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
                return () => unsubscribe();
            } else {
                // æ¨¡æ‹Ÿç™»å½•ï¼Œè®© UI å¯ç”¨
                setUser({ uid: 'demo-user', isAnonymous: true });
            }
          }, []);

          if (!user) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="w-8 h-8 animate-spin text-blue-500" /></div>;

          return (
            <>
              {view === 'login' && <LoginScreen setStudentName={setStudentName} setView={setView} />}
              {view === 'student' && <StoryPlanner studentName={studentName} user={user} setView={setView} />}
              {view === 'teacher' && <TeacherDashboard setView={setView} />}
            </>
          );
        };

        // --- LOGIN SCREEN ---
        const LoginScreen = ({ setStudentName, setView }) => {
          const [name, setName] = useState('');
          const handleEnter = () => {
            if (!name.trim()) return alert("è¯·è¾“å…¥ä½ çš„åå­—");
            setStudentName(name);
            setView('student');
          };
          return (
            <div className="min-h-screen bg-indigo-50 flex flex-col items-center justify-center p-4">
              <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                  <Edit3 className="w-10 h-10 text-blue-600" />
                </div>
                <h1 className="text-2xl font-bold text-gray-800 mb-2">P5 ä½œæ–‡å¤§çº²è§„åˆ’å™¨</h1>
                <p className="text-gray-500 mb-8">è¯·è¾“å…¥åå­—å¼€å§‹è§„åˆ’ä½ çš„ä½œæ–‡</p>
                <input type="text" placeholder="ä½ çš„åå­— (ä¾‹å¦‚: å°æ˜)" className="w-full border-2 border-gray-200 rounded-xl p-4 text-lg mb-4 focus:border-blue-500 outline-none transition" value={name} onChange={(e) => setName(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleEnter()} />
                <button onClick={handleEnter} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl text-lg hover:bg-blue-700 transition shadow-lg transform hover:-translate-y-1">å¼€å§‹å†™ä½œ</button>
                <div className="mt-8 pt-6 border-t border-gray-100">
                  <button onClick={() => setView('teacher')} className="text-gray-400 text-sm hover:text-gray-600 flex items-center justify-center gap-1 mx-auto"><Users className="w-4 h-4" /> è€å¸ˆå…¥å£</button>
                </div>
              </div>
            </div>
          );
        };

        // --- TEACHER DASHBOARD ---
        const TeacherDashboard = ({ setView }) => {
          const [submissions, setSubmissions] = useState([]);
          const [selectedStudent, setSelectedStudent] = useState(null);

          useEffect(() => {
            if (!isFirebaseAvailable) return;
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'student_plans');
            const unsubscribe = onSnapshot(q, (snapshot) => {
              const students = [];
              snapshot.forEach((doc) => { students.push({ id: doc.id, ...doc.data() }); });
              students.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));
              setSubmissions(students);
            });
            return () => unsubscribe();
          }, []);

          if (!isFirebaseAvailable) {
              return (
                  <div className="min-h-screen flex flex-col items-center justify-center text-center p-4">
                      <h1 className="text-2xl font-bold text-gray-800 mb-2">è€å¸ˆåå°æ¼”ç¤ºæ¨¡å¼</h1>
                      <p className="text-gray-500 mb-4">å› ä¸ºæ²¡æœ‰é…ç½® Firebaseï¼Œæ— æ³•æ‹‰å–çœŸå®æ•°æ®ã€‚</p>
                      <button onClick={() => setView('login')} className="text-blue-600 underline">è¿”å›</button>
                  </div>
              )
          }

          return (
            <div className="min-h-screen bg-gray-100 flex flex-col">
              <div className="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10">
                <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Users className="w-6 h-6 text-blue-600" /> è€å¸ˆåå°ç›‘æ§</h1>
                <button onClick={() => setView('login')} className="text-gray-500 hover:text-gray-800 font-bold">é€€å‡ºåå°</button>
              </div>
              <div className="flex flex-grow overflow-hidden">
                <div className="w-1/3 md:w-1/4 bg-white border-r overflow-y-auto">
                  <div className="p-4 bg-gray-50 border-b"><h2 className="font-bold text-gray-500 text-sm">å­¦ç”Ÿåå• ({submissions.length})</h2></div>
                  {submissions.length === 0 ? <div className="p-8 text-center text-gray-400">æš‚æ—¶æ²¡æœ‰å­¦ç”Ÿæäº¤</div> : submissions.map((student) => (
                      <div key={student.id} onClick={() => setSelectedStudent(student)} className={`p-4 border-b cursor-pointer hover:bg-blue-50 transition ${selectedStudent?.id === student.id ? 'bg-blue-100 border-l-4 border-l-blue-500' : ''}`}>
                        <div className="font-bold text-gray-800 text-lg">{student.name}</div>
                        <div className="text-xs text-gray-500 mt-1">{student.currentStep === 5 ? 'âœ… å·²å®Œæˆ' : `æ­£åœ¨å†™: ç¬¬ ${student.currentStep + 1} æ­¥`}</div>
                      </div>
                    ))}
                </div>
                <div className="w-2/3 md:w-3/4 bg-gray-50 p-6 overflow-y-auto">
                  {selectedStudent ? (
                    <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8">
                      <div className="flex items-center gap-3 mb-6 border-b pb-4">
                         <div className="bg-blue-100 text-blue-600 w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl">{selectedStudent.name[0]}</div>
                         <div><h2 className="text-2xl font-bold text-gray-800">{selectedStudent.name} çš„ä½œæ–‡å¤§çº²</h2></div>
                      </div>
                      <div className="space-y-6">
                        <ViewSection title="1. å¼€å¤´" color="green" data={[{ label: "æ—¶é—´/å¤©æ°”", val: selectedStudent.plan?.time + ', ' + selectedStudent.plan?.weather }, { label: "äººç‰©", val: selectedStudent.plan?.characters }, { label: "äº‹ä»¶", val: selectedStudent.plan?.openingEvent }]} />
                        <ViewSection title="2. å‘å±•" color="yellow" data={[{ label: "ä»»åŠ¡", val: selectedStudent.plan?.task }, { label: "å¿ƒæƒ…", val: selectedStudent.plan?.worry }]} />
                        <ViewSection title="3. é«˜æ½®" color="red" data={[{ label: "å¦¹å¦¹ (å¼€å¿ƒ)", val: selectedStudent.plan?.playgroundSister }, { label: "å°æ˜ (ç„¦æ€¥)", val: selectedStudent.plan?.playgroundXiaoming }]} />
                        <ViewSection title="4. è§£å†³" color="blue" data={[{ label: "å¦™è®¡", val: selectedStudent.plan?.solutionIdea }, { label: "è¡ŒåŠ¨", val: selectedStudent.plan?.solutionAction }]} />
                        <ViewSection title="5. ç»“å°¾" color="purple" data={[{ label: "å›å®¶å", val: selectedStudent.plan?.homeAction }, { label: "æ„Ÿæ‚Ÿ", val: selectedStudent.plan?.lesson }]} />
                      </div>
                    </div>
                  ) : <div className="h-full flex flex-col items-center justify-center text-gray-400"><Eye className="w-16 h-16 mb-4 opacity-20" /><p>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå­¦ç”ŸæŸ¥çœ‹è¯¦æƒ…</p></div>}
                </div>
              </div>
            </div>
          );
        };

        const ViewSection = ({ title, color, data }) => (
          <div className={`border-l-4 border-${color}-500 pl-4 py-1`}>
            <h3 className="font-bold text-lg mb-2 text-gray-800">{title}</h3>
            <div className="space-y-2">
              {data.map((item, i) => (
                <div key={i}>
                  <span className="text-xs font-bold text-gray-500 uppercase">{item.label}</span>
                  <p className="text-gray-800 bg-gray-50 p-2 rounded mt-1 border border-gray-100 min-h-[2rem]">{item.val || <span className="text-gray-400 italic">æœªå¡«å†™</span>}</p>
                </div>
              ))}
            </div>
          </div>
        );

        // --- STUDENT PLANNER ---
        const StoryPlanner = ({ studentName, user, setView }) => {
          const [currentStep, setCurrentStep] = useState(0);
          const [showTips, setShowTips] = useState(true);
          const [loadingField, setLoadingField] = useState(null);
          const [saveStatus, setSaveStatus] = useState(isFirebaseAvailable ? 'saved' : 'offline');
          const [aiReviewLoading, setAiReviewLoading] = useState(false);
          const [aiReview, setAiReview] = useState(null);

          const [plan, setPlan] = useState({
            time: '', weather: '', characters: '', openingEvent: '',
            task: '', worry: '',
            playgroundSister: '', playgroundXiaoming: '',
            solutionIdea: '', solutionAction: '',
            homeAction: '', lesson: ''
          });

          const steps = [
            { id: 'start', title: 'å¼€å¤´', icon: <Home className="w-8 h-8"/> },
            { id: 'rise', title: 'å‘å±•', icon: <Footprints className="w-8 h-8"/> },
            { id: 'climax', title: 'é«˜æ½®', icon: <Mountain className="w-8 h-8"/> },
            { id: 'fall', title: 'è§£å†³', icon: <Lightbulb className="w-8 h-8"/> },
            { id: 'end', title: 'ç»“å°¾', icon: <Flag className="w-8 h-8"/> }
          ];

          const tips = {
            0: (<div><p><strong>ğŸ’¡ FEAST æç¤ºï¼š</strong> äº¤ä»£èƒŒæ™¯ã€‚</p><ul><li><strong>å¤©æ°”:</strong> â€œéª„é˜³ä¼¼ç«â€æˆ–â€œé£å’Œæ—¥ä¸½â€ã€‚</li><li><strong>åŠ¨ä½œ:</strong> â€œå“¼ç€æ­Œå›å®¶â€æˆ–â€œæ‹–ç€æ²‰é‡çš„è„šæ­¥â€ã€‚</li></ul></div>),
            1: (<div><p><strong>ğŸ’¡ FEAST æç¤ºï¼š</strong> æå†™å¦ˆå¦ˆç”Ÿç—…ã€‚</p><ul><li><strong>è¡¨æƒ…:</strong> è„¸è‰²è‹ç™½ã€çœ‰å¤´ç´§é”ã€‚</li><li><strong>è¯­è¨€:</strong> å£°éŸ³æ²™å“‘ã€æœ‰æ°”æ— åŠ›ã€‚</li></ul></div>),
            2: (<div><p><strong>ğŸ’¡ é‡ç‚¹ï¼šå¼ºçƒˆçš„å¯¹æ¯”ï¼</strong></p><ul><li><strong>å¦¹å¦¹ (Happy):</strong> Action (æ‰‹èˆè¶³è¹ˆ)ã€‚</li><li><strong>å°æ˜ (Anxious):</strong> Feeling (å¿ƒæ€¥å¦‚ç„š), Action (ä¸åœçœ‹è¡¨)ã€‚</li></ul></div>),
            3: (<div><p><strong>ğŸ’¡ FEAST æç¤ºï¼š</strong> å±•ç¤ºæœºæ™ºã€‚</p><ul><li><strong>å¿ƒç†:</strong> çµæœºä¸€åŠ¨ï¼Œè®¡ä¸Šå¿ƒæ¥ã€‚</li><li><strong>è¯­è¨€:</strong> æ¸©æŸ”ã€ç¥ç§˜åœ°è¯´ã€‚</li></ul></div>),
            4: (<div><p><strong>ğŸ’¡ FEAST æç¤ºï¼š</strong> å‡åä¸»é¢˜ã€‚</p><ul><li><strong>åŠ¨ä½œ:</strong> è½»è½»ç›–è¢«å­ã€å€’æ°´ã€‚</li><li><strong>æ„Ÿæ‚Ÿ:</strong> æ˜ç™½äº†äº²æƒ…çš„å¯è´µã€‚</li></ul></div>)
          };

          useEffect(() => {
            if (!user || !studentName || !isFirebaseAvailable) return;
            const saveData = async () => {
              setSaveStatus('saving');
              try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'student_plans', studentName);
                await setDoc(docRef, { name: studentName, plan: plan, currentStep: currentStep, lastUpdated: serverTimestamp() }, { merge: true });
                setSaveStatus('saved');
              } catch (error) { console.error(error); setSaveStatus('error'); }
            };
            const timer = setTimeout(saveData, 1500);
            return () => clearTimeout(timer);
          }, [plan, currentStep, user, studentName]);

          const handleNext = () => { if (currentStep < steps.length) setCurrentStep(currentStep + 1); };
          const handlePrev = () => { if (currentStep > 0) setCurrentStep(currentStep - 1); };
          const updatePlan = (field, value) => { setPlan(prev => ({ ...prev, [field]: value })); };

          const generateContent = async (prompt) => {
            if (!GEMINI_API_KEY) return "è¯·åœ¨ä»£ç ä¸­é…ç½® GEMINI_API_KEY ä»¥ä½¿ç”¨ AI åŠŸèƒ½ã€‚";
            try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
              });
              const data = await response.json();
              return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI æš‚æ—¶æ— æ³•å›åº”ã€‚";
            } catch (e) { return "ç½‘ç»œé”™è¯¯ã€‚"; }
          };

          const handleAiPolish = async (field, contextHint) => {
            const currentText = plan[field];
            if (!currentText || currentText.trim().length < 2) return alert("è¯·å…ˆå†™ä¸€ç‚¹å†…å®¹ï¼ˆè‡³å°‘2ä¸ªå­—ï¼‰ï¼ŒAI æ‰èƒ½å¸®ä½ æ¶¦è‰²å“¦ï¼");
            setLoadingField(field);
            const prompt = `ä½ æ˜¯ä¸€ä½å¹½é»˜ä¸”ä¸¥æ ¼çš„æ–°åŠ å¡å°å­¦é«˜çº§åæ–‡è€å¸ˆã€‚å­¦ç”Ÿæ­£åœ¨å†™â€œ${contextHint}â€ï¼Œå†…å®¹ï¼šâ€œ${currentText}â€ã€‚è§„åˆ™ï¼š1. ä¸¥ç¦è„è¯ã€‚2. æ‹’ç»ä»£å†™ã€‚3. æ­£å¸¸æ¶¦è‰²ç”¨FEASTæŠ€å·§å’Œæˆè¯­ï¼Œ40å­—å†…ã€‚`;
            const result = await generateContent(prompt);
            updatePlan(field, result.trim());
            setLoadingField(null);
          };

          const handleAiReview = async () => {
            setAiReviewLoading(true);
            const prompt = `ä½ æ˜¯ä¸€ä½åæ–‡è€å¸ˆã€‚ç‚¹è¯„å­¦ç”Ÿå¤§çº²ï¼š${JSON.stringify(plan)}ã€‚ç»™å‡º1ä¸ªäº®ç‚¹å’Œ1ä¸ªå»ºè®®ï¼Œå…±100å­—ï¼Œè¯­æ°”é¼“åŠ±ã€‚`;
            const review = await generateContent(prompt);
            setAiReview(review);
            setAiReviewLoading(false);
          };

          const AiButton = ({ field, context }) => (
            <button onClick={() => handleAiPolish(field, context)} disabled={loadingField !== null} className="absolute right-2 bottom-2 text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-2 py-1 rounded-md flex items-center gap-1 transition disabled:opacity-50">
              {loadingField === field ? <Loader2 className="w-3 h-3 animate-spin" /> : <Wand2 className="w-3 h-3" />} {loadingField === field ? "..." : "AIæ¶¦è‰²"}
            </button>
          );

          if (currentStep === steps.length) {
            return (
              <div className="min-h-screen bg-gray-100 p-8 font-sans">
                <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden">
                  <div className="bg-blue-600 p-8 text-white flex justify-between items-center">
                    <h1 className="text-4xl font-bold flex items-center gap-4"><Map className="w-10 h-10" /> {studentName} çš„ä½œæˆ˜åœ°å›¾</h1>
                    <div className="flex gap-4">
                       <button onClick={handleAiReview} disabled={aiReviewLoading} className="bg-yellow-400 hover:bg-yellow-500 text-blue-900 px-6 py-3 rounded-lg flex items-center gap-2 transition text-lg font-bold shadow-lg disabled:opacity-70">{aiReviewLoading ? <Loader2 className="w-6 h-6 animate-spin" /> : <Sparkles className="w-6 h-6" />} {aiReviewLoading ? "æ‰¹æ”¹ä¸­..." : "AI ç‚¹è¯„"}</button>
                       <button onClick={() => setView('login')} className="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-lg flex items-center gap-2 transition text-lg font-bold border border-white/50"><LogIn className="w-6 h-6" /> é€€å‡º</button>
                    </div>
                  </div>
                  <div className="p-10 space-y-8">
                    {aiReview && (<div className="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200 rounded-xl p-6 shadow-inner"><h3 className="text-xl font-bold text-orange-800 mb-3 flex items-center gap-2"><MessageSquare className="w-6 h-6"/> è€å¸ˆç‚¹è¯„ï¼š</h3><div className="text-gray-800 whitespace-pre-line">{aiReview}</div></div>)}
                    <ViewSection title="1. å¼€å¤´" color="green" data={[{ label: "æ—¶é—´/å¤©æ°”", val: plan.time + ', ' + plan.weather }, { label: "äººç‰©", val: plan.characters }, { label: "äº‹ä»¶", val: plan.openingEvent }]} />
                    <ViewSection title="2. å‘å±•" color="yellow" data={[{ label: "ä»»åŠ¡", val: plan.task }, { label: "å¿ƒæƒ…", val: plan.worry }]} />
                    <ViewSection title="3. é«˜æ½®" color="red" data={[{ label: "å¦¹å¦¹ (å¼€å¿ƒ)", val: plan.playgroundSister }, { label: "å°æ˜ (ç„¦æ€¥)", val: plan.playgroundXiaoming }]} />
                    <ViewSection title="4. è§£å†³" color="blue" data={[{ label: "å¦™è®¡", val: plan.solutionIdea }, { label: "è¡ŒåŠ¨", val: plan.solutionAction }]} />
                    <ViewSection title="5. ç»“å°¾" color="purple" data={[{ label: "å›å®¶å", val: plan.homeAction }, { label: "æ„Ÿæ‚Ÿ", val: plan.lesson }]} />
                    <div className="mt-8 flex justify-center gap-6 print:hidden"><button onClick={() => setCurrentStep(0)} className="bg-gray-500 text-white px-8 py-3 rounded-xl text-lg font-bold hover:bg-gray-600 transition shadow-lg">è¿”å›ä¿®æ”¹</button></div>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-slate-50 flex flex-col items-center p-4 md:p-6 font-sans text-gray-800">
              <div className="w-full max-w-6xl mb-6">
                <div className="flex justify-between items-center mb-4">
                  <div className="flex items-center gap-4">
                    <h1 className="text-3xl font-bold text-slate-700 flex items-center gap-3"><Edit3 className="w-8 h-8" /> ä½œæ–‡è§„åˆ’</h1>
                    <div className="text-sm bg-white px-3 py-1 rounded-full shadow-sm text-gray-500 border flex items-center gap-2"><User className="w-4 h-4" /> å­¦ç”Ÿ: <span className="font-bold text-blue-600">{studentName}</span></div>
                    {saveStatus === 'saving' && <span className="text-xs text-blue-500 animate-pulse flex items-center gap-1"><Loader2 className="w-3 h-3 animate-spin"/> äº‘ç«¯ä¿å­˜ä¸­...</span>}
                    {saveStatus === 'saved' && <span className="text-xs text-green-500 flex items-center gap-1"><CheckCircle className="w-3 h-3"/> å·²ä¿å­˜</span>}
                    {saveStatus === 'offline' && <span className="text-xs text-gray-400 flex items-center gap-1">ç¦»çº¿æ¨¡å¼</span>}
                  </div>
                  <div className="text-lg font-bold text-slate-500 bg-slate-200 px-4 py-1 rounded-full">æ­¥éª¤ {currentStep + 1} / 5</div>
                </div>
                <div className="relative pt-2">
                  <div className="h-4 bg-gray-200 rounded-full overflow-hidden flex">
                    {steps.map((s, idx) => (<div key={idx} className={`h-full transition-all duration-500 border-r border-white/20 ${idx <= currentStep ? 'bg-blue-500' : 'bg-transparent'} flex-1`}/>))}
                  </div>
                  <div className="flex justify-between mt-2 px-2">
                    {steps.map((s, idx) => (<div key={idx} className={`flex flex-col items-center gap-1 ${idx === currentStep ? 'text-blue-600 scale-110' : 'text-gray-400'} transition-all`}><span className="text-lg md:text-xl font-bold">{s.title}</span></div>))}
                  </div>
                </div>
              </div>
              <div className="w-full max-w-6xl bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col lg:flex-row min-h-[550px]">
                <div className="w-full lg:w-1/3 bg-slate-800 text-white p-6 lg:p-8 flex flex-col relative overflow-hidden">
                  <div className="absolute top-0 right-0 p-40 bg-blue-500 rounded-full blur-3xl opacity-20 -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                  <div className="z-10">
                    <div className="inline-block p-3 bg-blue-600 rounded-2xl mb-6 shadow-lg">{steps[currentStep].icon}</div>
                    <h2 className="text-3xl font-bold mb-4">{steps[currentStep].title}</h2>
                    <div className="bg-slate-700/60 rounded-xl p-5 border border-slate-600 backdrop-blur-sm">
                      <div className="flex items-center gap-2 font-bold text-yellow-400 mb-2 text-xl cursor-pointer" onClick={() => setShowTips(!showTips)}><Lightbulb className="w-6 h-6" /> å†™ä½œå°é”¦å›Š {showTips ? 'â–²' : 'â–¼'}</div>
                      {showTips && <div className="text-slate-200 animate-fadeIn leading-relaxed">{tips[currentStep]}</div>}
                    </div>
                  </div>
                </div>
                <div className="w-full lg:w-2/3 p-6 lg:p-10 bg-white flex flex-col">
                  <div className="flex-grow space-y-6">
                    {currentStep === 0 && (
                      <div className="space-y-4 animate-fadeIn">
                        <div className="bg-blue-50 p-3 rounded-lg border border-blue-100"><h3 className="font-bold text-blue-700 mb-2 text-base flex items-center gap-2"><BookOpen className="w-4 h-4"/> ç‚¹é€‰ä¸€ä¸ªç²¾å½©å¼€å¤´ï¼š</h3><div className="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm text-gray-700"><button className="bg-white p-2 rounded border border-blue-200 hover:bg-blue-100 text-left transition" onClick={() => { updatePlan('weather', 'ä¹Œäº‘å¯†å¸ƒï¼Œé—·çƒ­å¾—è®©äººå–˜ä¸è¿‡æ°”'); updatePlan('openingEvent', 'å°æ˜æ­£æ€¥åŒ†åŒ†åœ°å¾€å®¶èµ¶ï¼Œå¿ƒé‡Œæƒ¦è®°ç€ç”Ÿç—…çš„å¦ˆå¦ˆã€‚'); }}>â˜ï¸ ç¯å¢ƒçƒ˜æ‰˜æ³•</button><button className="bg-white p-2 rounded border border-blue-200 hover:bg-blue-100 text-left transition" onClick={() => { updatePlan('weather', 'ä¸€ä¸ªé£å’Œæ—¥ä¸½çš„ä¸‹åˆ'); updatePlan('openingEvent', 'â€œæ”¾å­¦å•¦ï¼â€å°æ˜å“¼ç€æ­Œï¼Œè¿ˆç€è½»å¿«çš„æ­¥ä¼å›å®¶ã€‚'); }}>ğŸ¶ å£°éŸ³/å¯¹æ¯”æ³•</button><button className="bg-white p-2 rounded border border-blue-200 hover:bg-blue-100 text-left transition" onClick={() => { updatePlan('weather', 'çƒˆæ—¥å½“ç©º'); updatePlan('openingEvent', 'å°æ˜æ˜¯ä¸ªå‡ºäº†åçš„å­é¡ºå­©å­ã€‚æ”¾å­¦é“ƒä¸€å“ï¼Œä»–å°±...'); }}>ğŸ‘¤ äººç‰©ä»‹ç»æ³•</button></div></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="block text-base font-bold text-gray-700 mb-1">æ—¶é—´ & å¤©æ°”</label><input type="text" placeholder="ä¾‹ï¼šé—·çƒ­çš„ä¸‹åˆï¼Œä¹Œäº‘å¯†å¸ƒ" className="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-blue-500 outline-none transition" value={plan.weather} onChange={(e) => updatePlan('weather', e.target.value)} /></div><div><label className="block text-base font-bold text-gray-700 mb-1">äººç‰©</label><input type="text" placeholder="å°æ˜ã€å¦ˆå¦ˆã€å¦¹å¦¹" className="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-blue-500 outline-none transition" value={plan.characters} onChange={(e) => updatePlan('characters', e.target.value)} /></div></div>
                        <div className="relative"><label className="block text-base font-bold text-gray-700 mb-1">å¼€å¤´äº‹ä»¶</label><textarea placeholder="å°æ˜æ”¾å­¦å›åˆ°å®¶ï¼ŒæƒŠè®¶åœ°å‘ç°..." className="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-blue-500 outline-none transition h-20 resize-none" value={plan.openingEvent} onChange={(e) => updatePlan('openingEvent', e.target.value)} /><AiButton field="openingEvent" context="æ•…äº‹å¼€å¤´" /></div>
                      </div>
                    )}
                    {currentStep === 1 && (<div className="space-y-5 animate-fadeIn"><div className="relative"><label className="block text-lg font-bold text-gray-700 mb-2">å¦ˆå¦ˆäº¤ä»£äº†ä»€ä¹ˆä»»åŠ¡ï¼Ÿ</label><textarea placeholder="å¦ˆå¦ˆæŒ‡ç€å¢™ä¸Šçš„é’Ÿ..." className="w-full border-2 border-gray-200 rounded-lg p-4 focus:border-blue-500 outline-none transition h-32" value={plan.task} onChange={(e) => updatePlan('task', e.target.value)} /><AiButton field="task" context="å¦ˆå¦ˆç”Ÿç—…äº¤ä»£ä»»åŠ¡" /></div><div className="relative"><label className="block text-lg font-bold text-gray-700 mb-2">å½“æ—¶å°æ˜çš„å¿ƒæƒ…æ˜¯æ€æ ·çš„ï¼Ÿ</label><input type="text" placeholder="ä¾‹ï¼šå¿ƒé‡Œåƒå‹äº†ä¸€å—å¤§çŸ³å¤´..." className="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-blue-500 outline-none transition" value={plan.worry} onChange={(e) => updatePlan('worry', e.target.value)} /><AiButton field="worry" context="å°æ˜æ‹…å¿ƒå¦ˆå¦ˆçš„å¿ƒæƒ…" /></div></div>)}
                    {currentStep === 2 && (<div className="space-y-6 animate-fadeIn"><div className="text-center text-gray-500 mb-2 italic text-sm">è¿™é‡Œéœ€è¦å†™å‡ºå¼ºçƒˆçš„åå·®ï¼</div><div className="grid grid-cols-1 md:grid-cols-2 gap-6 relative"><div className="hidden md:flex absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10"><div className="bg-slate-700 text-white text-xl px-4 py-2 rounded-full font-bold shadow-lg border-4 border-white">VS</div></div><div className="bg-green-50 p-4 rounded-xl border-2 border-green-200 shadow-sm relative"><label className="block text-lg font-bold text-green-700 mb-2 flex items-center gap-2"><Smile className="w-5 h-5"/> å¦¹å¦¹ (å¼€å¿ƒ)</label><textarea placeholder="åŠ¨ä½œï¼šæ‰‹èˆè¶³è¹ˆ..." className="w-full bg-white border border-green-300 rounded-lg p-3 focus:ring-2 focus:ring-green-400 outline-none transition h-32" value={plan.playgroundSister} onChange={(e) => updatePlan('playgroundSister', e.target.value)} /><AiButton field="playgroundSister" context="å¦¹å¦¹å¼€å¿ƒåœ°ç©" /></div><div className="bg-red-50 p-4 rounded-xl border-2 border-red-200 shadow-sm relative"><label className="block text-lg font-bold text-red-700 mb-2 flex items-center gap-2"><Frown className="w-5 h-5"/> å°æ˜ (ç„¦æ€¥)</label><textarea placeholder="å¿ƒç†ï¼šå¦ˆå¦ˆè¿˜åœ¨å®¶..." className="w-full bg-white border border-red-300 rounded-lg p-3 focus:ring-2 focus:ring-red-400 outline-none transition h-32" value={plan.playgroundXiaoming} onChange={(e) => updatePlan('playgroundXiaoming', e.target.value)} /><AiButton field="playgroundXiaoming" context="å°æ˜å¿ƒæ€¥å¦‚ç„š" /></div></div></div>)}
                    {currentStep === 3 && (<div className="space-y-5 animate-fadeIn"><div><label className="block text-lg font-bold text-gray-700 mb-2">å°æ˜æƒ³åˆ°äº†ä»€ä¹ˆå¦™è®¡ï¼Ÿ</label><input type="text" placeholder="ä¾‹ï¼šå°æ˜çœ¼ç å­éª¨ç¢Œä¸€è½¬..." className="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-blue-500 outline-none transition" value={plan.solutionIdea} onChange={(e) => updatePlan('solutionIdea', e.target.value)} /></div><div className="relative"><label className="block text-lg font-bold text-gray-700 mb-2">ä»–æ˜¯æ€ä¹ˆåšçš„/è¯´çš„ï¼Ÿ</label><textarea placeholder="å°æ˜è¹²ä¸‹èº«å­ï¼Œç¥ç§˜åœ°è¯´..." className="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-blue-500 outline-none transition h-32" value={plan.solutionAction} onChange={(e) => updatePlan('solutionAction', e.target.value)} /><AiButton field="solutionAction" context="å°æ˜åŠå¦¹å¦¹" /></div></div>)}
                    {currentStep === 4 && (<div className="space-y-4 animate-fadeIn"><div className="bg-purple-50 p-3 rounded-lg border border-purple-100"><h3 className="font-bold text-purple-700 mb-2 text-base flex items-center gap-2"><Star className="w-4 h-4"/> ç‚¹é€‰ä¸€ä¸ªç²¾å½©ç»“å±€ï¼š</h3><div className="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm text-gray-700"><button className="bg-white p-2 rounded border border-purple-200 hover:bg-purple-100 text-left transition" onClick={() => updatePlan('lesson', 'çœ‹ç€å¦ˆå¦ˆæ¬£æ…°çš„ç¬‘å®¹ï¼Œå°æ˜å¿ƒé‡Œæ¯”åƒäº†èœœè¿˜ç”œã€‚')}>ğŸ¯ ç”œèœœæ„Ÿæ‚Ÿ</button><button className="bg-white p-2 rounded border border-purple-200 hover:bg-purple-100 text-left transition" onClick={() => updatePlan('lesson', 'ç»è¿‡è¿™ä»¶äº‹ï¼Œå°æ˜æ˜ç™½äº†â€œç™¾å–„å­ä¸ºå…ˆâ€çš„é“ç†ã€‚')}>ğŸ“œ å¼•ç”¨åè¨€</button><button className="bg-white p-2 rounded border border-purple-200 hover:bg-purple-100 text-left transition" onClick={() => updatePlan('lesson', 'çª—å¤–çš„é›¨åœäº†ï¼Œä¸€é“å½©è™¹æŒ‚åœ¨å¤©è¾¹ã€‚')}>ğŸŒˆ æ™¯ç‰©çƒ˜æ‰˜</button></div></div><div className="relative"><label className="block text-base font-bold text-gray-700 mb-1">å›åˆ°å®¶ååšäº†ä»€ä¹ˆï¼Ÿ</label><textarea placeholder="ä»–ä»¬è½»æ‰‹è½»è„šåœ°èµ°è¿›æˆ¿é—´..." className="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-blue-500 outline-none transition h-20 resize-none" value={plan.homeAction} onChange={(e) => updatePlan('homeAction', e.target.value)} /><AiButton field="homeAction" context="ç…§é¡¾å¦ˆå¦ˆ" /></div><div><label className="block text-base font-bold text-gray-700 mb-1">æ„Ÿæƒ³/é“ç†</label><input type="text" placeholder="ä¾‹ï¼šå°æ˜è§‰å¾—..." className="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-blue-500 outline-none transition" value={plan.lesson} onChange={(e) => updatePlan('lesson', e.target.value)} /></div></div>)}
                  </div>
                  <div className="flex justify-between mt-6 pt-4 border-t border-gray-100"><button onClick={handlePrev} disabled={currentStep === 0} className={`flex items-center gap-2 px-6 py-2 rounded-lg text-lg font-bold transition ${currentStep === 0 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-100'}`}><ArrowLeft className="w-6 h-6" /> ä¸Šä¸€æ­¥</button><button onClick={handleNext} className="flex items-center gap-2 px-8 py-3 bg-blue-600 text-white rounded-lg text-lg font-bold shadow-lg hover:bg-blue-700 hover:shadow-xl transition transform hover:-translate-y-1">{currentStep === steps.length - 1 ? 'å®Œæˆè§„åˆ’' : 'ä¸‹ä¸€æ­¥'} <ArrowRight className="w-6 h-6" /></button></div>
                </div>
              </div>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>